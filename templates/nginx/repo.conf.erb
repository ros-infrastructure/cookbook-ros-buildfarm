proxy_cache_path /var/cache/nginx_rpm_md_cache levels=1:2 keys_zone=rpm_md_cache:10m max_size=1g inactive=1d use_temp_path=off;

server {
	listen 80 default_server;
	server_name repo;
	root /var/repos;

	location / {
		autoindex on;
		index index.html;
	}

	set $no_cache 1;
	if ($request_uri ~* "/repodata/.*-.*\.xml\.gz$") {
		set $no_cache 0;
	}

	<%- @rpm_repos.each do |dist, versions| -%>
		<%- versions.each do |version, architectures| -%>
	location /<%= dist %>/building/<%= version %>/SRPMS/ {
		proxy_pass	http://127.0.0.1:24816/pulp/content/ros-building-<%= dist %>-<%= version %>-SRPMS/;
		proxy_cache		rpm_md_cache;
		proxy_cache_valid	200	1d;
		proxy_no_cache		$no_cache;
		proxy_cache_bypass	$no_cache;
	}
			<%- architectures.each do |arch| -%>
	location /<%= dist %>/building/<%= version %>/<%= arch %>/debug/ {
		proxy_pass	http://127.0.0.1:24816/pulp/content/ros-building-<%= dist %>-<%= version %>-<%= arch %>-debug/;
		proxy_cache		rpm_md_cache;
		proxy_cache_valid	200	1d;
		proxy_no_cache		$no_cache;
		proxy_cache_bypass	$no_cache;
	}
	location /<%= dist %>/building/<%= version %>/<%= arch %>/ {
		proxy_pass	http://127.0.0.1:24816/pulp/content/ros-building-<%= dist %>-<%= version %>-<%= arch %>/;
		proxy_cache		rpm_md_cache;
		proxy_cache_valid	200	1d;
		proxy_no_cache		$no_cache;
		proxy_cache_bypass	$no_cache;
	}

			<%- end -%>
		<%- end -%>
	<%- end -%>
	location ^~ \.(dsc|deb|tar\.gz)$ {
		# Use sendfile to send debs directly via kernel syscalls,
		# avoiding copying data from kernel to userspace and back.
		sendfile on;

		# These options complement sendfile in interesting ways:
		# tcp_nopush: Wait until packets are full before sending
		# tcp_nodelay: Don't wait to send if there is data ready
		# tcp_nopush takes prioirity unless the packet contains a FIN
		# at which point the tcp_nodelay option causes the last packet
		# to be sent at once.
		tcp_nopush on;
		tcp_nodelay on;
	}
}
